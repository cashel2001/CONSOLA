#include <Arduino.h>
#include <LiquidCrystal_I2C.h>
#include <Keypad.h>

#define TAM 44 // Definimos el numero maximo de caracteres en el array de recepcion de datos (4 TRAMAS DE 11 BYTES)
LiquidCrystal_I2C lcd( 0x27, 16, 2 ); // direccion de memoria 0x20 para proteus --- 0x27 para lcd fisico

byte ByteRead;
byte variable =0;
byte tramaglobal[TAM];
byte trama1[11]; // arrays que guardan los bytes recibidos, 11 es por los dos bytes del principio + byte de final + 8 bytes
byte trama2[11];
byte trama3[11];
byte trama4[11];
byte j = 0;
bool flag = false;

const byte ROWS = 4; //four rows
const byte COLS = 4; //four columns
char keys[ROWS][COLS] = {
  {'1','2','3','A'},
  {'4','5','6','B'},
  {'7','8','9','C'},
  {'*','0','#','D'}
};
byte rowPins[ROWS] = {5, 4, 3, 2}; //connect to the row pinouts of the keypad
byte colPins[COLS] = {9, 8, 7, 6}; //connect to the column pinouts of the keypad

Keypad keypad = Keypad( makeKeymap(keys), rowPins, colPins, ROWS, COLS );

void setup()
 {

    Serial.begin(9600);
    lcd.init();
    lcd.backlight();
    lcd.clear();
    lcd.print("test rekoba");

}

void loop() {

 if(Serial.available())
  {
    
       trama1[j]=Serial.read();
       Serial.print ("La posicion del byte en el array es:");Serial.println(j);
       Serial.print("El dato que he recibido en hexadecimal es:");Serial.print(trama1[j]);Serial.println();
       j++;
       
      if ( j == 11)
      {
         if (( trama1[0] == 2) && ( trama1[1] == 5 ) && ( trama1[10] == 3 ))  //j=11; ha terminado de recibir la trama
         { 
          lcd.setCursor(0,0);
          Serial.println();
          Serial.println("TRAMA CORRECTA!!!!!!!!!!!!!!!");
         
          j=0;
          Serial.println("El valor de j es:");
          Serial.print(j);
           for ( int i=2 ; i<10 ; i++ )
           {
             lcd.write(trama1[i]);
             Serial.write(trama1 [i]);
           
           }
            Serial.println();
         }

       else 
       {
         Serial.println("trama incorrecta");
         j=0;
       }
    }       
       
  }  
  char key = keypad.getKey();
  
  if (key){
    Serial.println(key);
  }
 
}
